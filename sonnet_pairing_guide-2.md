# Claude Sonnet 4.5 ペアプロガイド（realize_EC 用）
## セッション設計＆プロンプトテンプレ集

---

## このガイドの目的

Rails 8 + Solidus + さくら VPS で realize_EC を実装するときに、Claude Sonnet 4.5 を **継続的なペアプロ相方**として使うためのルール集とテンプレです。

毎回説明するのが面倒な「前提」「ルール」「よく使うプロンプト」を、ここにまとめてコピペして使えるようにしています。

---

## セッション開始テンプレ

**新しいチャットを開くときに、以下をそのまま最初のメッセージとして貼ってください。**

```
あなたは Rails 8 + Solidus + Kamal 2 を使った EC サイト「realize_EC」のペアプロ相方です。

【プロジェクト概要】
- リポジトリ: realize_EC（GitHub）
- 構成: 1つのリポジトリで3ストア（radica, shrimpshells, huhfreg）を Git ブランチ・タグで管理
- 環境変数 STORE_NAME で、ストア別の設定を自動切り替え
- 本番: さくら VPS（Ubuntu 22.04, メモリ 2GB）+ Kamal 2
- 言語: Ruby 3.3.0+, Rails 8.x, Solidus 最新版

【重要な制約】
- PostgreSQL を使用（SQLite は使わない）
- Redis 不要（Solid Queue / Cache / Cable で Postgres ベース）
- Docker + docker-compose（ローカル開発）
- 単一リポジトリで3ストア管理（namespace ではなく STORE_NAME 環境変数で分岐）

【やってほしいこと】
1. まず「理解のための確認質問」を3つだけ出してから提案してください
2. コードをいきなり全部書かず、以下の順で進めてください
   - 1) 実装方針（箇条書き）
   - 2) 変更予定ファイル一覧
   - 3) ファイルごとのパッチ（diff 形式推奨）
3. 長くなりそうなときは「ここまでで一旦区切る」と明示してください

【禁止事項】
- 実在しない gem 名や API 名を勝手に作らない
- Rails / Solidus / Kamal のバージョンを勝手に仮定しない（わからないときは質問）
- `localStorage` や `IndexedDB` などのブラウザ API をサーバサイドで使わない
- マイグレーション失敗時の復旧コードを提示せず、「安全な方法を提案する」こと

【便利な情報】
- ローカルでは 3 ターミナル同時起動（radica:3000, shrimpshells:3001, huhfreg:3002）
- 本番デプロイは `kamal deploy` ワンコマンド
- DB は `STORE_NAME` に応じて自動分岐（realize_ec_radica_*, realize_ec_shrimpshells_*, ...）

ここまでを理解したら、まず「確認質問」を 3 つだけ出してください。
```

---

## 機能実装用テンプレ

**新機能を実装してほしいときに使うテンプレです。**

```
【対象ストア】
- STORE_NAME: radica / shrimpshells / huhfreg のいずれか

【対象ブランチ】
- 現在のブランチ: feature/radica/xxxx
- ベースブランチ: develop

【実装したい機能】
- 機能名:
- 概要:
- ユースケース（1-3行）:

【関連画面 or API】
- URL パス:
- HTTP メソッド:
- パラメータ:
- レスポンス形式:

【既存コードの参考】
- 類似する機能:
- 既存ファイル:

【質問・留意点】
- これ以外に必要な情報があれば質問してください
- わからないことがあれば遠慮なく聞いてください

お願いしたい進め方:
1. 確認質問（3つ以内）
2. 実装方針（箇条書き）
3. 変更ファイル一覧
4. 各ファイルのパッチ
```

---

## バグ調査・デバッグ用テンプレ

**本番環境や開発環境でバグが出たときに使うテンプレです。**

```
【現象】
- 実際にどう壊れているか（画面キャプチャ、エラーメッセージなど）

【期待動作】
- 本来どう動いてほしいか

【再現手順】
1. ページ A にアクセス
2. ボタン B をクリック
3. 入力欄に「◯◯」を入力
4. 送信
→ ◯◯という現象が発生

【エラーログ / スタックトレース】
（存在すれば上位 10-20 行だけ貼る）

【関連コード】
- app/controllers/xxx_controller.rb（該当箇所だけ）
- app/models/yyy.rb（該当箇所だけ）
- app/views/zzz.html.erb（該当箇所だけ）

【環境情報】
- 発生環境: 本番 / ステージング / ローカル
- ストア: radica / shrimpshells / huhfreg
- Ruby / Rails バージョン

【お願い】
1. 原因候補を 2-3 個、確信度つきでリストアップ
2. 各候補の確認方法をガイド
3. 最も可能性の高い原因の修正案を提示
```

---

## 既存コードのリファクタ用テンプレ

**複雑になったコードをシンプルにしたいときに使うテンプレです。**

```
【対象ファイル】
- path: app/controllers/xxx.rb
- 概要: 何をしているクラス / メソッドか（1-2 行）

【現状の問題】
- 複雑さの源：
- 問題のある部分：
- 負債として感じている部分：

【制約】
- 外部インターフェース（メソッドシグネチャ）は変えたくない / 変えてもいい
- テストは既存のまま保つ
- 既存の依存関係を壊さない

【参考情報】
- 関連テスト:
- 呼び出し元:
- Solidus や Rails の関連ドキュメント:

【お願い】
1. 現状コードを簡潔に要約
2. 「においを指摘」（複雑さの源を特定）
3. リファクタ案を「ステップごと」に提案
4. 各ステップでテストが通ることを確認しながら進める
```

---

## 設計レビュー用テンプレ

**新機能を実装する前に、設計の良し悪しをレビューしてほしいときに使うテンプレです。**

```
【機能概要】
- 機能名:
- 一言説明:
- 詳細なユースケース:

【今の設計案】
- モデル層:
  - どんなモデルを追加 / 変更するか
  - どんなバリデーション / association が必要か
  
- サービス層 / ビジネスロジック層:
  - どこに処理を入れるか
  - 外部 API（Stripe など）呼び出しはあるか
  
- コントローラー / ルーティング:
  - どんなエンドポイントを追加するか
  - どんなレスポンスを返すか
  
- View / UI:
  - どんなフォーム / ボタンを追加するか
  - ストア別に表示を分岐する必要があるか

【懸念点】
- 今のところ心配なことがあれば記載
- 「うーん、これでいいのかな」という部分

【制約】
- Stripe 周りは実装ずみ
- 複数ストアで共通の機能にしたい
- 既存の Order フローには影響を与えたくない

【お願い】
1. 設計の良い点 / 悪い点を指摘
2. Rails / Solidus 的によりよいパターンがあれば提案
3. 「今やるべき最低限」と「将来の改善」を分けてリスト化
4. 実装の難度見積もり（1, 2, 3, 5, 8 時間）
```

---

## Stripe 統合用テンプレ

**決済周りの実装で Sonnet に相談するときに使うテンプレです。**

```
【実装内容】
- ストア別の Stripe キー設定はすでに config/initializers/stripe_config.rb で完成
- やりたいこと: ◯◯（新しい決済フロー、Webhook 受信など）

【現在の状態】
- Solidus の Stripe 統合は solidus_stripe gem で実装済み
- Payment State Machine は Solidus 標準フロー
- Webhook は https://radica.example.com/stripe_webhooks で受け取り中

【やりたい処理】
- 例: 注文完了時に Stripe Charge を作成
- 例: 払い戻し時に Refund API を呼び出し
- 例: Webhook で受け取った stripe.payment_intent.succeeded イベントを処理

【送信データ / レスポンス】
- Stripe に送る内容（カード情報はマスク）
- Stripe からのレスポンス例

【お願い】
1. 「この実装方法だと問題あるか」をチェック
2. セキュリティ上の注意点を指摘
3. ストア別のキー切り替えが正しく動くか確認
```

---

## セッションを区切るタイミング

以下の時点で、**新しいチャット（新しいセッション）を開くのがおすすめです。**

✅ **セッション終了タイミング**
- 1つの機能が「テスト通過 + 簡単な QA」まで完了した
- 実装 → テスト → コミット → PR 作成 まで終わった
- 大きく違う機能に移る

❌ **セッション継続（同じチャットで続ける）**
- 同じ機能の小さなバグ修正
- テスト追加
- ドキュメント書き直し
- 同じファイルのリファクタ

**理由**: Sonnet はコンテキストウィンドウ（トークン数）に上限があるので、セッション切ると「無駄なトークン」を節約できます。

---

## よくある質問への答え方

### Q: Sonnet に「このコードで大丈夫か」を聞きたい

```
「以下のコード案で大丈夫ですか？確認すべきポイントがあれば教えてください。」

その後、コードを貼る。

Sonnet は「実装の良し悪し」「セキュリティ懸念」「パフォーマンス問題」を指摘してくれます。
```

### Q: Sonnet が長すぎるコードを提案してきた

```
「このコードを 3 つのステップに分割して、各ステップごとに説明してください。」

または

「重要な部分だけ抜き出してください。」
```

### Q: Sonnet が Rails / Solidus の古いパターンを提案してきた

```
「Rails 8 / Solidus 最新版での推奨パターンは何ですか？」

Sonnet は自分で更新するので、古いパターンを指摘すると修正してくれます。
```

### Q: Sonnet の説明が理解できない

```
「◯◯の部分をもっと簡潔に / より詳しく説明してください。」

または

「図解で説明してください。」（テキスト図解でも OK）
```

---

## セッション管理のベストプラクティス

| 場面 | 推奨アクション |
|------|-------------|
| **新機能の設計** | テンプレ貼る → 確認質問 → 設計決定 → 実装開始 |
| **実装中にバグ発生** | デバッグテンプレ → Sonnet に原因調査 → 修正提案 |
| **テスト書き直し** | 「このテストは何をテストしているか」と聞く |
| **ドキュメント作成** | 「README 用に簡潔に説明してください」と聞く |
| **デプロイ前確認** | 「本番デプロイ前にチェックすべきことは」と聞く |

---

## セキュリティ確認用の定型質問

デプロイ前に、必ず以下をはい/いいえで確認してください。

```
【セキュリティチェックリスト】

□ SQL インジェクション対策
  - Active Record の :where に直接ユーザ入力を入れていないか
  - サニタイズすべき入力がないか

□ CSRF 対策
  - POST / PUT / DELETE エンドポイントに protect_from_forgery がある
  - API 呼び出しに CSRF トークンが含まれている

□ 認証 / 認可
  - ログイン必須エンドポイントに authenticate_user! が入っているか
  - 他ストアのデータを見られないか（STORE_NAME チェック）

□ 決済データの安全性
  - Stripe キーを環境変数で管理しているか
  - カード番号などを直接保存していないか

□ 情報漏洩対策
  - エラーメッセージに本番データが含まれていないか
  - ログに パスワード / API キーが出ていないか

□ API セキュリティ
  - Rate limiting を設定しているか
  - API キーの検証をしているか

これを Sonnet に確認してもらいます:
「上の セキュリティチェックリストをクリアしているか確認してください。問題あればリストアップしてください。」
```

---

## まとめ

このガイドを使えば、Sonnet 4.5 と効率的にペアプロできます。

**大事なポイント:**

1. **セッション開始時**にテンプレを貼る → Sonnet が「理解した」と応答
2. **機能ごとにテンプレを使い分ける** → 確認質問が減ります
3. **セッションを定期的に区切る** → トークン数を節約
4. **セキュリティ確認を忘れずに** → 本番デプロイ前は必ず確認

---

## 次のステップ

1. 新しいチャット開く
2. 「セッション開始テンプレ」を貼る
3. Sonnet の確認質問を待つ
4. Day 1 セットアップを一緒に進める

では、実装スタートです！🚀
